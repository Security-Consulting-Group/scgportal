{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .status-select {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }
    .status-not_started { background-color: #6c757d; color: white; }
    .status-in_review { background-color: #ffc107; color: black; }
    .status-monitoring { background-color: #007bff; color: white; }
    .status-mitigated { background-color: #17a2b8; color: white; }
    .status-fixed { background-color: #28a745; color: white; }
    .status-risk_accepted { background-color: #dc3545; color: white; }

    .accordion-button:not(.collapsed) {
        background-color: #e7f1ff;
    }
    .accordion-body {
        background-color: #f8f9fa;
    }
    .risk-factor-Critical { background-color: #7030A0B3; }
    .risk-factor-High { background-color: #C00100B3; }
    .risk-factor-Medium { background-color: #FF9932B3; }
    .risk-factor-Low { background-color: #FFCC03B3; }
    .risk-factor-Informational { background-color: #99CC02B3; }
</style>
{% endblock %}

{% block content %}
<h2 class="main_heading">Report Details</h2>
<hr>
<p><strong>Report ID:</strong> {{ report.report_id }}</p>
<p><strong>Report Name:</strong> {{ report.name }}</p>
<p><strong>Customer:</strong> {{ report.customer.customer_name }}</p>
<p><strong>Date:</strong> {{ report.date }}</p>
<p><strong>Inventory:</strong> {{ report.inventory|join:', ' }}</p>

<h3>Vulnerabilities</h3>
<div class="accordion" id="vulnerabilitiesAccordion">
    {% for group in grouped_vulnerabilities %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading-{{ group.risk_factor }}">
                <button class="accordion-button collapsed risk-factor-{{ group.risk_factor }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ group.risk_factor }}" aria-expanded="false" aria-controls="collapse-{{ group.risk_factor }}">
                    {{ group.risk_factor }} ({{ group.vulnerabilities|length }})
                </button>
            </h2>
            <div id="collapse-{{ group.risk_factor }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ group.risk_factor }}" data-bs-parent="#vulnerabilitiesAccordion">
                <div class="accordion-body">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-6">
                            <label for="bulk-action-{{ group.risk_factor }}" class="form-label mb-md-0"><strong>Set the action for all targets under {{ group.risk_factor }} risk category vulnerabilities as:</strong></label>
                        </div>
                        <div class="col-md-6">
                            <select class="form-control bulk-action-select" data-risk-factor="{{ group.risk_factor }}">
                                <option value="">Select action...</option>
                                {% for value, label in report.vulnerabilities.first.STATUS_CHOICES %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="accordion" id="innerAccordion-{{ group.risk_factor }}">
                        {% for vuln in group.vulnerabilities %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="innerHeading-{{ group.risk_factor }}-{{ vuln.signature.id }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#innerCollapse-{{ group.risk_factor }}-{{ vuln.signature.id }}" aria-expanded="false" aria-controls="innerCollapse-{{ group.risk_factor }}-{{ vuln.signature.id }}">
                                        {{ vuln.signature.name }}
                                    </button>
                                </h2>
                                <div id="innerCollapse-{{ group.risk_factor }}-{{ vuln.signature.id }}" class="accordion-collapse collapse" aria-labelledby="innerHeading-{{ group.risk_factor }}-{{ vuln.signature.id }}" data-bs-parent="#innerAccordion-{{ group.risk_factor }}">
                                    <div class="accordion-body">
                                        <div class="row g-3 mb-3">
                                            <div class="col-sm-4">
                                                <p class="mb-sm-0"><strong>ID:</strong> {{ vuln.signature.id }}</p>
                                            </div>
                                            <div class="col-sm-4">
                                                <p class="mb-sm-0"><strong>Rating:</strong> {{ vuln.signature.risk_factor }}</p>
                                            </div>
                                            <div class="col-sm-4">
                                                <p class="mb-sm-0"><strong>CVSS Score:</strong> {{ vuln.signature.cvss_base_score }}</p>
                                            </div>
                                        </div>
                                        <p><strong>Description:</strong> {{ vuln.signature.description | linebreaks }}</p>
                                        
                                        {% if vuln.signature.solution %}
                                            <p><strong>Recommended Solution:</strong> {{ vuln.signature.solution }}</p>
                                        {% endif %}
                                        
                                        {% if vuln.signature.cve %}
                                        <p><strong>CVE:</strong></p>
                                        <ul class="list-inline">
                                        {% for cve in vuln.signature.cve %}
                                            <li class="list-inline-item">
                                                <a href="https://nvd.nist.gov/vuln/detail/{{ cve }}" target="_blank" rel="noopener noreferrer">{{ cve }}</a>
                                            </li>
                                        {% endfor %}
                                        </ul>
                                    {% endif %}
                                    
                                    {% if vuln.signature.references %}
                                        <p><strong>References:</strong></p>
                                        <ul class="list-inline">
                                        {% for reference in vuln.signature.references %}
                                            <li class="list-inline-item">
                                                <a href="{{ reference }}" target="_blank" rel="noopener noreferrer">{{ reference }}</a>
                                            </li>
                                        {% endfor %}
                                        </ul>
                                    {% endif %}

                                        <hr>
                                        <h4>Targets Affected:</h4>
                                        <div class="row align-items-center mb-3">
                                            <div class="col-md-6">
                                                <label for="bulk-action-vuln-{{ vuln.signature.id }}" class="form-label mb-md-0"><strong>Set the action for all targets in this Vulnerability as:</strong></label>
                                            </div>
                                            <div class="col-md-6">
                                                <select class="form-select bulk-action-vuln-select" id="bulk-action-vuln-{{ vuln.signature.id }}" data-vulnerability-id="{{ vuln.targets.0.id }}">
                                                    <option value="">Select action...</option>
                                                    {% for value, label in vuln.targets.0.STATUS_CHOICES %}
                                                        <option value="{{ value }}">{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Target Affected</th>
                                                    <th>Status</th>
                                                    <th>Last Changed By</th>
                                                    <th>Last Changed At</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for target in vuln.targets %}
                                                <tr>
                                                    <td>{{ target.target_affected }}</td>
                                                    <td>
                                                        <select class="form-control status-select status-{{ target.status }}" data-vulnerability-id="{{ target.id }}">
                                                            {% for value, label in target.STATUS_CHOICES %}
                                                            <option value="{{ value }}" {% if target.status == value %}selected{% endif %}>{{ label }}</option>
                                                        {% endfor %}
                                                        </select>
                                                    </td>
                                                    <td>{{ target.changed_by|default:"N/A" }}</td>
                                                    <td>{{ target.changed_at }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</div>
<hr>
<div class="right-aligned">
    <a href="{% url 'reports:report_list' customer_id=report.customer.customer_id service_id=report.service.service_id %}" class="btn btn-secondary">Back to List</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function addStatusChangeListener(selector, bulkType) {
        document.querySelectorAll(selector).forEach(function(select) {
            select.addEventListener('change', function() {
                var data = {
                    status: this.value,
                    bulk_type: bulkType
                };
                if (bulkType === 'risk_factor') {
                    data.risk_factor = this.closest('.accordion-item').querySelector('.accordion-button').textContent.split('(')[0].trim();
                } else {
                    data.vulnerability_id = this.dataset.vulnerabilityId;
                }
                updateStatus(data);
            });
        });
    }

    addStatusChangeListener('.status-select', 'individual');
    addStatusChangeListener('.bulk-action-select', 'risk_factor');
    addStatusChangeListener('.bulk-action-vuln-select', 'vulnerability');

    function updateStatus(data) {
        fetch('{% url "reports:report_detail" customer_id=report.customer.customer_id service_id=report.service.service_id pk=report.report_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateUI(data.updated_vulnerabilities);
            } else {
                alert('Failed to update status: ' + data.error);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('An error occurred while updating the status');
        });
    }

    function updateUI(updatedVulnerabilities) {
        updatedVulnerabilities.forEach(vuln => {
            const statusSelect = document.querySelector(`.status-select[data-vulnerability-id="${vuln.id}"]`);
            if (statusSelect) {
                statusSelect.value = vuln.status;
                
                // Remove all existing status classes
                statusSelect.classList.remove('status-not_started', 'status-in_review', 'status-monitoring', 'status-mitigated', 'status-fixed', 'status-risk_accepted');
                
                // Add the new status class
                statusSelect.classList.add(`status-${vuln.status}`);
                
                const row = statusSelect.closest('tr');
                if (row) {
                    const changedByCell = row.querySelector('td:nth-child(3)');
                    const changedAtCell = row.querySelector('td:nth-child(4)');
                    if (changedByCell) changedByCell.textContent = vuln.changed_by;
                    if (changedAtCell) changedAtCell.textContent = formatDate(vuln.changed_at);
                }
            }
        });
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    }
});
</script>
{% endblock %}