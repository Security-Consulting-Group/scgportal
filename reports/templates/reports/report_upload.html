{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<h2>Upload Report</h2>
<hr>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form|crispy }}
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Upload</button>
        <a href="{% url 'reports:report_list' customer_id=request.selected_customer.customer_id service_id=service.service_id %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const contractSelect = document.getElementById('id_contract');
        const serviceSelect = document.getElementById('id_service');

        contractSelect.addEventListener('change', function() {
            const contractId = this.value;
            if (contractId) {
                fetch(`{% url 'reports:report_upload' customer_id=request.selected_customer.customer_id service_id=service.service_id %}?contract_id=${contractId}`)
                    .then(response => response.json())
                    .then(data => {
                        serviceSelect.innerHTML = '<option value="">---------</option>';
                        data.services.forEach(service => {
                            const option = document.createElement('option');
                            option.value = service.id;
                            option.textContent = service.service_name;
                            serviceSelect.appendChild(option);
                        });
                        serviceSelect.disabled = false;
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                serviceSelect.innerHTML = '<option value="">---------</option>';
                serviceSelect.disabled = true;
            }
        });
    });
</script>
{% endblock %}